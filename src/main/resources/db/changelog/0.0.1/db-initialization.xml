<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
	<!-- To help make scripts database-independent, the following “generic” 
		data types will be converted to the correct database implementation: BOOLEAN 
		CURRENCY UUID CLOB BLOB DATE DATETIME TIME BIGINT Or use tokens configured/described 
		at maser.xml https://www.liquibase.org/documentation/ -->


	<changeSet id="20180808-users-table" author="ProjectX-anonymous">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="users" />
			</not>
		</preConditions>
		<comment>Create table users</comment>
		<createTable tableName="users">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="nickname" type="${VARCHAR_64}">
				<constraints nullable="false" />
			</column>
			<column name="email" type="${VARCHAR_128}" />
			<column name="phone" type="${VARCHAR_64}" />
			<column name="password" type="${VARCHAR_64}" />
			<column name="registered" type="DATETIME" />
			<column name="logged" type="DATETIME" />
			<column name="facebook_id" type="${VARCHAR_64}" />
			<column name="google_id" type="${VARCHAR_64}" />
		</createTable>
	</changeSet>

	<changeSet id="20180808-user-profiles-table" author="ProjectX-anonymous">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="user_profiles" />
			</not>
		</preConditions>
		<comment>Create table user_profiles</comment>
		<createTable tableName="user_profiles">
			<column name="user_id" type="BIGINT">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="about" type="${LONGTEXT}" />
			<column name="birthdate" type="DATE" />
			<column name="avatar_link" type="${LONGTEXT}" />
			<column name="location" type="${LONGTEXT}" />
			<column name="twitter_id" type="${VARCHAR_64}" />
			<column name="instagram_id" type="${VARCHAR_64}" />
		</createTable>
		<addForeignKeyConstraint baseTableName="user_profiles"
			baseColumnNames="user_id" constraintName="UserProfileReference"
			referencedTableName="users" referencedColumnNames="id" />
	</changeSet>

	<changeSet id="20180808-shop_templates-table" author="ProjectX-anonymous">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="shop_templates" />
			</not>
		</preConditions>
		<comment>Create table shop_templates</comment>
		<createTable tableName="shop_templates">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="${VARCHAR_64}" />
			<column name="html_template" type="${LONGTEXT}" />
		</createTable>
	</changeSet>

	<changeSet id="20180808-shops-table" author="ProjectX-anonymous">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="shops" />
			</not>
		</preConditions>
		<comment>Create table shops</comment>
		<createTable tableName="shops">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="admin_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="opening_date" type="DATE" />
			<column name="location" type="${LONGTEXT}" />
			<column name="template_id" type="BIGINT" />
		</createTable>

		<addForeignKeyConstraint baseTableName="shops"
			baseColumnNames="admin_id" constraintName="ShopToUserReference"
			referencedTableName="users" referencedColumnNames="id" />
		<addForeignKeyConstraint baseTableName="shops"
			baseColumnNames="template_id" constraintName="ShopToShopTemplateReference"
			referencedTableName="shop_templates" referencedColumnNames="id" />
        <addUniqueConstraint constraintName="AdminIdUniqueConstraint"
            columnNames="admin_id" tableName="shops"/>
	</changeSet>
	
	
	<changeSet id="20180808-user_shop_management_relation-table" author="ProjectX-anonymous">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="user_shop_management_relation" />
			</not>
		</preConditions>
		<comment>Create table user_shop_management_relation</comment>
		<createTable tableName="user_shop_management_relation">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="user_id" type="BIGINT" />
			<column name="shop_id" type="BIGINT" />
		</createTable>
		
		<addForeignKeyConstraint baseTableName="user_shop_management_relation"
			baseColumnNames="user_id" constraintName="ShopUserManagementRelationToUserReference"
			referencedTableName="users" referencedColumnNames="id" />
		<addForeignKeyConstraint baseTableName="user_shop_management_relation"
			baseColumnNames="shop_id" constraintName="ShopUserManagementRelationToShopReference"
			referencedTableName="shops" referencedColumnNames="id" />
	</changeSet>

	<changeSet id="20180808-user_user_follow_relation-table" author="ProjectX-anonymous">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="user_user_follow_relation" />
			</not>
		</preConditions>
		<comment>Create table user_user_follow_relation</comment>
		<createTable tableName="user_user_follow_relation">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="follower_id" type="BIGINT" />
			<column name="followee_id" type="BIGINT" />
		</createTable>
		
		<addForeignKeyConstraint baseTableName="user_user_relation"
			baseColumnNames="follower_id" constraintName="UserUserFollowRelationToUserReference1"
			referencedTableName="users" referencedColumnNames="id" />
		<addForeignKeyConstraint baseTableName="user_user_relation"
			baseColumnNames="followee_id" constraintName="UserUserFollowRelationToUserReference2"
			referencedTableName="users" referencedColumnNames="id" />	
	</changeSet>

    <changeSet id="20180808-user_shop_assesment_relation-table" author="ProjectX-anonymous">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="user_shop_assesment_relation" />
            </not>
        </preConditions>
        <comment>Create table user_shop_assesment_relation</comment>
        <createTable tableName="user_shop_assesment_relation">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="user_id" type="BIGINT" />
            <column name="shop_id" type="BIGINT" />
            <column name="mark" type="SMALLINT" />
        </createTable>
        <sql>
            ALTER TABLE user_shop_assesment_relation ADD CONSTRAINT check_mark CHECK (mark>0 AND mark<5)
        </sql>
        <addForeignKeyConstraint baseTableName="user_shop_assesment_relation"
                                 baseColumnNames="user_id" constraintName="UserShopAsseementRelationToUsersReference"
                                 referencedTableName="users" referencedColumnNames="id" />
        <addForeignKeyConstraint baseTableName="user_shop_assesment_relation"
                                 baseColumnNames="shop_id" constraintName="UserShopAssesmentRelationToShopsReference"
                                 referencedTableName="shops" referencedColumnNames="id" />
    </changeSet>

	<changeSet id="20180808-subscription_list-table" author="ProjectX-anonymous">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="subscription_list" />
			</not>
		</preConditions>
		<comment>Create table subscription_list</comment>
		<createTable tableName="subscription_list">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="user_id" type="BIGINT" />
			<column name="email" type="${VARCHAR_128}" />
		</createTable>

		<addForeignKeyConstraint baseTableName="subscription_list"
			baseColumnNames="user_id" constraintName="SubsciptionListToUserReference"
			referencedTableName="users" referencedColumnNames="id" />
	</changeSet>
	
	<changeSet id="20180808-labels-table" author="ProjectX-anonymous">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="labels" />
			</not>
		</preConditions>
		<comment>Create table labels</comment>
		<createTable tableName="labels">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="${VARCHAR_128}">
				<constraints nullable="false" />
			</column>
			<column name="description" type="${LONGTEXT}">
				<constraints nullable="false" />
			</column>
            <column name="is_category" type="BOOLEAN" defaultValueBoolean="true"/>
			<column name="parent_id" type="BIGINT" />
		</createTable>
		
		<addForeignKeyConstraint baseTableName="labels"
			baseColumnNames="parent_id" constraintName="CatalogCategoryToCatalogCategoryReference"
			referencedTableName="labels" referencedColumnNames="id" />
	</changeSet>

    <changeSet id="20180808-products-table" author="ProjectX-anonymous">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="products" />
            </not>
        </preConditions>
        <comment>Create table products</comment>
        <createTable tableName="products">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="name" type="${VARCHAR_128}">
                <constraints nullable="false" />
            </column>
            <column name="description" type="${LONGTEXT}">
                <constraints nullable="false" />
            </column>
            <column name="shop_id" type="BIGINT" />
            <column name="price" type="NUMBER" />
        </createTable>

        <addForeignKeyConstraint baseTableName="products"
            baseColumnNames="shop_id" constraintName="ProductToShopReference"
            referencedTableName="shops" referencedColumnNames="id" />
    </changeSet>
    <changeSet id="20180808-product_images-table" author="ProjectX-anonymous">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="product_images" />
            </not>
        </preConditions>
        <comment>Create table product images</comment>
        <createTable tableName="product_images">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="image_link" type="${LONGTEXT}">
                <constraints nullable="false" />
            </column>
            <column name="product_id" type="BIGINT" />
        </createTable>

        <addForeignKeyConstraint baseTableName="product_images"
            baseColumnNames="product_id" constraintName="ProductImagesToProductReference"
            referencedTableName="products" referencedColumnNames="id" />
    </changeSet>


</databaseChangeLog>